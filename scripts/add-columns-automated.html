<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Social Media Columns - CFM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #16a34a;
            margin-bottom: 10px;
        }
        button {
            background: #16a34a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        button:hover {
            background: #15803d;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
        }
        .success { color: #16a34a; }
        .error { color: #dc2626; }
        .info { color: #2563eb; }
        .warning { color: #ea580c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Add Social Media Columns to CFM Database</h1>
        <p>This tool will automatically add the required social media columns to your companies table.</p>

        <button id="addColumnsBtn" onclick="addColumns()">Add Columns to Database</button>
        <button id="setupDataBtn" onclick="setupCFMData()" style="display: none; background: #2563eb;">
            Setup CFM Company Data
        </button>

        <div class="log" id="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://niivkjrhszjuyboqrirj.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5paXZranJoc3pqdXlib3FyaXJqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDQxNSwiZXhwIjoyMDc5NTcwNDE1fQ.OGZ1hsO8TC-3KapaMr3ai5qYnF99DuG5MHDF4S837Pg';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function addColumns() {
            const btn = document.getElementById('addColumnsBtn');
            btn.disabled = true;
            btn.textContent = 'Adding columns...';

            log('ðŸš€ Starting column addition...', 'info');

            try {
                // Execute SQL to add columns
                const sql = `
                    ALTER TABLE companies
                    ADD COLUMN IF NOT EXISTS linkedin_url TEXT,
                    ADD COLUMN IF NOT EXISTS facebook_url TEXT,
                    ADD COLUMN IF NOT EXISTS instagram_url TEXT;
                `;

                log('ðŸ“ Executing SQL to add columns...', 'info');

                // Try using RPC if available
                const { data, error } = await supabase.rpc('exec_sql', { sql });

                if (error) {
                    if (error.message.includes('exec_sql')) {
                        log('âš ï¸  Direct SQL execution not available', 'warning');
                        log('Please follow manual instructions below:', 'warning');
                        log('', 'info');
                        log('1. Go to: https://supabase.com/dashboard/project/niivkjrhszjuyboqrirj/editor', 'info');
                        log('2. Click on SQL Editor in the sidebar', 'info');
                        log('3. Paste and run this SQL:', 'info');
                        log('', 'info');
                        log('ALTER TABLE companies', 'info');
                        log('ADD COLUMN IF NOT EXISTS linkedin_url TEXT,', 'info');
                        log('ADD COLUMN IF NOT EXISTS facebook_url TEXT,', 'info');
                        log('ADD COLUMN IF NOT EXISTS instagram_url TEXT;', 'info');
                        log('', 'info');
                        log('4. Then click "Setup CFM Company Data" button below', 'success');
                        document.getElementById('setupDataBtn').style.display = 'inline-block';
                    } else {
                        throw error;
                    }
                } else {
                    log('âœ… Columns added successfully!', 'success');
                    document.getElementById('setupDataBtn').style.display = 'inline-block';
                }

            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                log('Please add columns manually via Supabase Dashboard', 'warning');
                document.getElementById('setupDataBtn').style.display = 'inline-block';
            } finally {
                btn.textContent = 'Columns Added';
            }
        }

        async function setupCFMData() {
            const btn = document.getElementById('setupDataBtn');
            btn.disabled = true;
            btn.textContent = 'Setting up data...';

            log('ðŸš€ Setting up CFM company data...', 'info');

            try {
                // Find CFM company
                log('ðŸ“ Looking for CFM company...', 'info');
                const { data: companies, error: fetchError } = await supabase
                    .from('companies')
                    .select('*')
                    .or('name.ilike.%CFM%,slug.ilike.%cfm%')
                    .limit(1);

                if (fetchError) throw fetchError;

                if (!companies || companies.length === 0) {
                    log('âŒ No CFM company found. Please create one first.', 'error');
                    return;
                }

                const companyId = companies[0].id;
                log(`âœ… Found CFM company (ID: ${companyId})`, 'success');

                // Update company data
                log('ðŸ“ Updating company information...', 'info');
                const { error: updateError } = await supabase
                    .from('companies')
                    .update({
                        name: 'CFM',
                        description: "Mozambican public company responsible for managing and operating the country's ports and railways. Its mission is to provide integrated and efficient logistical solutions for goods and passengers, contributing to the economic development of Mozambique and the wider region.",
                        footer_text: 'PORTOS E CAMINHOS DE FERRO DE MOÃ‡AMBIQUE, E.P.',
                        website_url: 'https://www.cfm.co.mz',
                        linkedin_url: 'https://linkedin.com/company/cfm-mozambique',
                        facebook_url: 'https://facebook.com/CFMMocambique',
                        instagram_url: 'https://instagram.com/cfm_mozambique',
                    })
                    .eq('id', companyId);

                if (updateError) {
                    log(`âš ï¸  Warning: ${updateError.message}`, 'warning');
                    log('Some fields may not have been updated. Check if columns exist.', 'warning');
                } else {
                    log('âœ… Company information updated successfully!', 'success');
                }

                log('', 'info');
                log('âœ… Setup complete!', 'success');
                log('ðŸŽ‰ Next steps:', 'success');
                log('   1. Go to /dashboard/company/settings', 'info');
                log('   2. Verify the company data', 'info');
                log('   3. Create an employee card to test', 'info');

                btn.textContent = 'Setup Complete âœ“';
                btn.style.background = '#16a34a';

            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'Retry Setup';
            }
        }

        // Auto-start on page load
        window.addEventListener('load', () => {
            log('ðŸ‘‹ Welcome to CFM Database Setup', 'success');
            log('Click "Add Columns to Database" to begin', 'info');
        });
    </script>
</body>
</html>
